<!doctype html>
<html>
<head>
    <title>#reckless</title>
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <style type="text/css">
    body {
        font-family: sans-serif;
    }
    #stats {
        position: fixed;
        top: 5px;
        left: 5px;
        font-size: 10px;
    }
    #mynetwork {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
    }
    </style>
</head>
<body>
    <div id="stats"></div>
    <div id="mynetwork"></div>

<script type="text/javascript">

function load(data)
{
    var nodess = [];
    for (i = 0; i < data.nodes.length; i++)
    {
        var label = data.nodes[i].pub_key.substring(0, 14);
        if (label != data.nodes[i].alias.substring(0, 14))
            label += '\n' + data.nodes[i].alias.replace(/\0/g, '').substring(0, 20);
        
        nodess.push({
            id: data.nodes[i].pub_key,
            label: label,
            color: {
                border: data.nodes[i].color,
                background: '#FFFFFF'
            },
            font: {
                size: 12
            },
            margin: 10
        });
    }
    // create an array with nodes
    var nodes = new vis.DataSet(nodess);

    var capacity = 0;
    var edgess = [];
    for (i = 0; i < data.edges.length; i++)
    {
        capacity += parseInt(data.edges[i].capacity);
        edgess.push({
            label: data.edges[i].channel_id.substring(0,12),
            to: data.edges[i].node1_pub,
            from: data.edges[i].node2_pub,
            width: Math.log(data.edges[i].capacity)/5,
            font: {
                size: 10,
                align: 'middle'
            }
        });
    }

    // create an array with edges
    var edges = new vis.DataSet(edgess);

    // create a network
    var container = document.getElementById('mynetwork');
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
        physics: {
            solver: 'forceAtlas2Based'
        },
        interaction: {
            hover: true
        }
    };
    
    var network = new vis.Network(container, data, options);

    $.getJSON('https://blockchain.info/ticker', function(pricedata) {
        var capusd = capacity*pricedata.USD.last/Math.pow(10,8);
        $('#stats').html(`Nodes: ${data.nodes.length}<br/>Channels: ${data.edges.length}<br/>Total Capacity: ${capacity} sat (${capusd.toFixed(2)} $)<br/>Total Fees: too small`);
    });
}

$.getJSON('/networkgraph', function(data)
{
    load(data);
});

</script>


</body>
</html>
